<!DOCTYPE html>
<html lang="zh">
    <head>
    <!-- 
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.3.0 -->

    <!-- Title -->
    
    <title>
        
            H5游戏接入技术小结（下） | 
        
        zakariyyasv&#39;s blog
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!-- Meta & Info -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="zakariyyasv">
    <meta name="description" content="Just forcus">
    <meta name="keywords" content="null">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="zakariyyasv&#39;s blog">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://zakariyyasv.pub">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="H5游戏接入技术小结（下） | zakariyyasv&#39;s blog">
    <meta property="og:description" content="Just forcus">
    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.en.js"></script>
        
    <![endif]-->

    <!-- Import CSS -->
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="/css/style.min.css">
    <!-- Config CSS -->


<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }
</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>



    <script src="/js/jquery.min.js"></script>
    <script src="/js/queue.js"></script>

    <!-- UC Browser Compatible -->
    <script>
        var agent = navigator.userAgent.toLowerCase();
        if(agent.indexOf('ucbrowser')>0) {
            document.write("<link rel=\"stylesheet\" href=\"/css/uc.css\">");
            alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
        }
    </script>

    

    

    <!-- Bing Background -->
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#概览"><span class="post-toc-number">1.</span> <span class="post-toc-text">概览</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#app与H5游戏交互"><span class="post-toc-number">2.</span> <span class="post-toc-text">app与H5游戏交互</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#UIWebView与JavaScriptCore交互"><span class="post-toc-number">3.</span> <span class="post-toc-text">UIWebView与JavaScriptCore交互</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#OC调用JS"><span class="post-toc-number">3.0.1.</span> <span class="post-toc-text">OC调用JS</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#JS调用OC"><span class="post-toc-number">3.0.2.</span> <span class="post-toc-text">JS调用OC</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#WKWebView与原生JS交互"><span class="post-toc-number">4.</span> <span class="post-toc-text">WKWebView与原生JS交互</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#Web页面"><span class="post-toc-number">4.0.1.</span> <span class="post-toc-text">Web页面</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#原生app"><span class="post-toc-number">4.0.2.</span> <span class="post-toc-text">原生app</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#原生app调用JS"><span class="post-toc-number">4.0.3.</span> <span class="post-toc-text">原生app调用JS</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#JS调用原生app"><span class="post-toc-number">4.0.4.</span> <span class="post-toc-text">JS调用原生app</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#代码"><span class="post-toc-number">5.</span> <span class="post-toc-text">代码</span></a></li></ol>

        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script>
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').css('background-image', 'url(' + '/img/random/material-' + randomNum + '.png' + ')');
</script>

        
    
            <p class="article-headline-p">
                H5游戏接入技术小结（下）
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>zakariyyasv</strong>
        <span>5月 20, 2016</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=H5游戏接入技术小结（下）&url=http://zakariyyasv.pub//2016/05/20/H5游戏接入技术小结（下）/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=H5游戏接入技术小结（下）&url=http://zakariyyasv.pub//2016/05/20/H5游戏接入技术小结（下）/index.html&via=zakariyyasv" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://zakariyyasv.pub//2016/05/20/H5游戏接入技术小结（下）/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://zakariyyasv.pub//2016/05/20/H5游戏接入技术小结（下）/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h3 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h3><p>在上一篇<a href="http://zakariyyasv.pub/2016/05/17/H5%E6%B8%B8%E6%88%8F%E6%8E%A5%E5%85%A5%E6%8A%80%E6%9C%AF%E5%B0%8F%E7%BB%93%EF%BC%88%E4%B8%8A%EF%BC%89/">H5游戏接入技术小结（上）</a>中，主要介绍了H5游戏资源的下载和运行。本篇文章主要是介绍app与H5游戏的交互以及在线与其他玩家对战的技术总结。<br><a id="more"></a></p>
<h3 id="app与H5游戏交互"><a href="#app与H5游戏交互" class="headerlink" title="app与H5游戏交互"></a>app与H5游戏交互</h3><p>app与游戏交互本质上就是app与浏览器进行交互，交互的媒介自然是要靠JS。交互的内容倒并不复杂，复杂的在于iOS版本的适配。iOS中<code>webview</code>有两个类<code>UIWebView</code>和<code>WKWebView</code>，性能方面来说<code>WKWebView</code>会更好一些（如果你对<code>UIWebView</code>和<code>WKWebView</code>的区别不太了解，可以看这篇<a href="http://nshipster.cn/wkwebkit/" target="_blank" rel="external">博文</a>），但<code>WKWebView</code>是iOS 8之后才引入的，故iOS 8之前的版本只能采用<code>UIWebView</code>。JS与OC交互的类库用的较多的是<code>JavaScriptCore</code>和<code>WebViewJavaScriptBridge</code>，其中<code>JavaScriptCore</code>是iOS 7之后苹果开放的类库，而<code>WebViewJavaScriptBridge</code>则是第三方类库，并且作者也说明了对于<code>WKWebView</code>的支持上还存在bug。综合来看最佳的解决方案应该是<code>WKWebView</code>与<code>JavaScriptCore</code>的组合，然而在<code>WKWebView</code>中我们无法获取context，也就是说<code>WKWebView</code>不支持<code>JavaScriptCore</code>。综合考虑后，还是决定采用UIWebView与JavaScriptCore组合(iOS 7)与WKWebView与原生JS组合(iOS 8及以上)的方案。</p>
<h3 id="UIWebView与JavaScriptCore交互"><a href="#UIWebView与JavaScriptCore交互" class="headerlink" title="UIWebView与JavaScriptCore交互"></a>UIWebView与JavaScriptCore交互</h3><p>相比于<code>WebViewJavaScriptBridge</code>，<code>JavaScriptCore</code>的学习成本要更低一些。<code>JavaScriptCore</code>中包含了以下几个类：</p>
<blockquote>
<ul>
<li>JSContext</li>
<li>JSManagedValue</li>
<li>JSValue</li>
<li>JSVirtualMachine</li>
</ul>
</blockquote>
<p><code>JSContext</code>对象代表了JS的运行环境，我们可以创建和使用JS上下文来执行OC或者swift代码中的JS脚本，访问JS中定义或者计算出的值，让JS可以访问原生的对象，方法或者函数。<code>JSValue</code>是对JS中的值的引用。你可以用<code>JSValue</code>类在JS和OC（或swift）进行值类型的转换来互相传递数据。你还可以用该类创建JS对象封装原生的自定义类的对象或方法。<code>JSManagedValue</code>对象是对JSValue对象的封装，增加了“条件持有”的行为来对值进行自动内存管理。该类最基本的使用场景是将JS值存储在OC（或swift）对象中并将其传递给JS代码。<code>JSVirtualMachine</code>对象代表的是独立的JS运行环境。使用这个类有两个目的：支持JS并发执行和管理在JS和OC（或swift）桥接对象的内存。</p>
<h5 id="OC调用JS"><a href="#OC调用JS" class="headerlink" title="OC调用JS"></a>OC调用JS</h5><p>OC中调用JS代码主要依赖<code>JSContext</code>和<code>JSValue</code>类，一个 JSContext 是一个全局环境的实例。调用JS代码主要调用<code>JSContext</code>的<code>evaluteScript</code>方法，创建一个 JSContext 后，可以很容易地运行 JavaScript 代码来创建变量，做计算，甚至定义方法：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">JSContext *context = [[JSContext alloc] init];</div><div class="line">[context evaluateScript:<span class="string">@"var num = 5 + 5"</span>];</div><div class="line">[context evaluateScript:<span class="string">@"var names = ['Grace', 'Ada', 'Margaret']"</span>];</div><div class="line">[context evaluateScript:<span class="string">@"var triple = function(value) &#123; return value * 3 &#125;"</span>];</div><div class="line">JSValue *tripleNum = [context evaluateScript:<span class="string">@"triple(num)"</span>];</div></pre></td></tr></table></figure>
<p>代码的最后一行，任何出自<code>JSContext</code>的值都被包裹在一个<code>JSValue</code>对象中。像JavaScript 这样的动态语言需要一个动态类型，所以<code>JSValue</code>包装了每一个可能的JavaScript值：字符串和数字；数组、对象和方法；甚至错误和特殊的JavaScript值诸如null和undefined。如果想将<code>JSValue</code>类型转为OC（或swift）下的数据类型，可以调用<code>JSValue</code>相关的方法实现：</p>
<p><img src="/images/h5game/3.png" alt=""></p>
<p>若想调用JS代码中的方法，可以使用下标方式或者调用<code>objectForKeyedSubscript:</code>方法来实现。例如，我在JS文件中定义了求阶乘的方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> factorial = <span class="function"><span class="keyword">function</span>(<span class="params">n</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span>)</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">if</span> (n === <span class="number">0</span>)</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    <span class="keyword">return</span> n * factorial(n - <span class="number">1</span>)</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>在OC中我们可以这样去调用计算阶乘的方法：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">JSContext context = [[JSContext alloc] init];</div><div class="line"><span class="comment">// 执行指定路径下JS文件中的代码</span></div><div class="line">[context evaluateScript:[<span class="built_in">NSString</span> stringWithContentsOfFile:path encoding:<span class="built_in">NSUTF8StringEncoding</span> error:<span class="literal">nil</span>]];</div><div class="line"><span class="comment">// 1.下标访问</span></div><div class="line">JSValue *function = <span class="keyword">self</span>.context[<span class="string">@"factorial"</span>];</div><div class="line"><span class="comment">// 2.方法访问</span></div><div class="line">JSValue *function = [<span class="keyword">self</span>.context objectForKeyedSubscript:<span class="string">@"factorial"</span>];</div><div class="line"><span class="comment">// 调用阶乘方法并传递参数</span></div><div class="line">JSValue *result = [function callWithArguments:@[@<span class="number">5</span>]];</div></pre></td></tr></table></figure>
<p>同时，<code>JSContext</code>也提供对于引用和异常本身的回调处理——通过设置context的<code>exceptionHandler</code>属性。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">context.exceptionHandler = ^(JSContext *context, JSValue *exception)&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"JS Error: %@"</span>, exception);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h5 id="JS调用OC"><a href="#JS调用OC" class="headerlink" title="JS调用OC"></a>JS调用OC</h5><p>JS访问客户端代码的方式主要有两种：block和<code>JSExport</code>协议。</p>
<p>先说第一种：block。当一个block被赋给<code>JSContext</code>里的一个标识符，<code>JavaScriptCore</code>会自动的把block封装在JS函数里。这使得在JS中可以简单的使用Foundation和Cocoa类，所有的桥接都为你做好了。例如下面代码中，弹出alertView的block被赋给context的”alert”，如果想要在JS中调用这个block，只需要调用<code>alert()</code>方法并传入参数即可。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">context[<span class="string">@"alert"</span>] = ^(<span class="built_in">NSString</span> *str)&#123;</div><div class="line">    <span class="built_in">UIAlertView</span> *alert = [[<span class="built_in">UIAlertView</span> alloc]initWithTitle:<span class="string">@"msg from js"</span> message:str delegate:<span class="literal">nil</span> cancelButtonTitle:<span class="string">@"ok"</span> otherButtonTitles:<span class="literal">nil</span>];</div><div class="line">    [alert show];</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [context evaluateScript:<span class="string">@"alert('hello')"</span>]);</div></pre></td></tr></table></figure>
<p>block方式使用起来很简单，但也有需要注意的地方。由于block对变量是强引用，而<code>JSContext</code>也强引用所有的变量，因此很容易会产生循环引用问题。这里有些注意点总结如下：</p>
<p>1.在block中不要直接使用context，而是用[JSContext currentContext]得到当前上下文。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 错误示范</span></div><div class="line"><span class="keyword">self</span>.context[<span class="string">@"name"</span>] = ^()&#123;</div><div class="line">     JSValue *value = [JSValue valueWithObject:<span class="string">@"aaa"</span> inContext:<span class="keyword">self</span>.context];</div><div class="line">&#125;;</div><div class="line"><span class="comment">// 正确做法</span></div><div class="line"><span class="keyword">self</span>.context[<span class="string">@"name"</span>] = ^()&#123;</div><div class="line">     JSValue *value = [JSValue valueWithObject:<span class="string">@"aaa"</span> inContext:[JSContext currentContext]];</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>2.不要在block中引用外部变量，而是将其作为参数进行传递。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">JSValue *value = [JSValue valueWithObject:<span class="string">@"ssss"</span> inContext:<span class="keyword">self</span>.context];</div><div class="line"><span class="comment">// 错误</span></div><div class="line"><span class="keyword">self</span>.context[<span class="string">@"name"</span>] = ^()&#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,value);</div><div class="line">    &#125;;</div><div class="line"><span class="comment">// 正确</span></div><div class="line"><span class="keyword">self</span>.context[<span class="string">@"name"</span>] = ^(<span class="built_in">NSString</span> *str)&#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,str);</div><div class="line">    &#125;;</div></pre></td></tr></table></figure>
<p>再说第二种：<code>JSExport</code>协议。这个协议可以让JS代码访问OC的类实例，实例方法，类方法和属性。以下以Person类为例来说明。首先，需要定义<code>PersonJSExpoert</code>协议继承<code>JSContext</code>，这个协议指定哪些属性和方法在JS中是可用的。然后，Person类需要去遵守并实现<code>PersonJSExpoert</code>协议。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//  Person.h </span></div><div class="line"><span class="class"><span class="keyword">@class</span> <span class="title">Person</span>;</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">PersonJSExports</span> &lt;<span class="title">JSExport</span>&gt;</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *firstName;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *lastName;</div><div class="line"><span class="keyword">@property</span> <span class="built_in">NSInteger</span> ageToday;</div><div class="line"></div><div class="line">- (<span class="built_in">NSString</span> *)getFullName;</div><div class="line"><span class="comment">// create and return a new Person instance with `firstName` and `lastName`</span></div><div class="line">+ (<span class="keyword">instancetype</span>)createWithFirstName:(<span class="built_in">NSString</span> *)firstName lastName:(<span class="built_in">NSString</span> *)lastName;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span> &lt;<span class="title">PersonJSExports</span>&gt;</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *firstName;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *lastName;</div><div class="line"><span class="keyword">@property</span> <span class="built_in">NSInteger</span> ageToday;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">// Person.m </span></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="built_in">NSString</span> *)getFullName &#123;</div><div class="line">    <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@ %@"</span>, <span class="keyword">self</span>.firstName, <span class="keyword">self</span>.lastName];</div><div class="line">&#125;</div><div class="line">+ (<span class="keyword">instancetype</span>) createWithFirstName:(<span class="built_in">NSString</span> *)firstName lastName:(<span class="built_in">NSString</span> *)lastName &#123;</div><div class="line">    Person *person = [[Person alloc] init];</div><div class="line">    person.firstName = firstName;</div><div class="line">    person.lastName = lastName;</div><div class="line">    <span class="keyword">return</span> person;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>这样在JS中就可以创建新的Person实例,在这个例子中，<code>Objective-C</code>的方法<code>createWithFirstName:lastName:</code>变成了在JavaScript中的<code>createWithFirstNameLastName()</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> loadPeopleFromJSON = <span class="function"><span class="keyword">function</span>(<span class="params">jsonString</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> data = <span class="built_in">JSON</span>.parse(jsonString);</div><div class="line">    <span class="keyword">var</span> people = [];</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; data.length; i++) &#123;</div><div class="line">        <span class="keyword">var</span> person = Person.createWithFirstNameLastName(data[i].first, data[i].last);</div><div class="line">        person.birthYear = data[i].year;</div><div class="line">        people.push(person);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> people;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>JavaScriptCore</code>介绍完了，那么在<code>UIWebView</code>中若想要拿到<code>JSContext</code>对象，就要调用下面这个方法：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[webView valueForKeyPath:<span class="string">@"documentView.webView.mainFrame.javaScriptContext"</span>]</div></pre></td></tr></table></figure></p>
<p>这里涉及到<code>UIWebView</code>创建JSContext上下文环境的时机问题，那么什么时候<code>UIWebView</code>会创建JSContext的上下文环境呢？<br>默认情况下，在渲染网页时遇到<code>&lt;script&gt;</code>标签时，就会创建JSContext上下文环境去运行JS代码。还有就是调用<code>[webView valueForKeyPath:@&quot;documentView.webView.mainFrame.javaScriptContext&quot;]</code>去获取JSContext环境时，这时无论是否遇到<code>&lt;script&gt;</code>标签，都会去创造出来一个JSContext环境，而且和遇到<code>&lt;script&gt;</code>标签创造的环境是同一个。</p>
<p>这时候又牵扯到何时注入JSContext的问题。我通常都会在<code>- (void)webViewDidFinishLoad:(UIWebView *)webView</code>中去注入交互对象，但是这时候网页还没加载完，JavaScript那边已经调用交互方法，这样就会调不到原生应用的方法而出现问题。如果改成在<code>- (void)viewDidLoad</code>中去注入交互对象，这样倒是解决了上面的问题，但是同时又引起了一个新的问题就是在一个网页内部点击链接跳转到另一个网页的时候，第二个页面需要交互，这时JSContext环境已经变化，但是<code>- (void)viewDidLoad</code>仅仅加载一次，跳转的时候，没有再次注入交互对象，这样就会导致第二个页面没法进行交互。当然你可以在<code>- (void)viewDidLoad和- (void)webViewDidFinishLoad:(UIWebView *)webView</code>都注入一次。</p>
<h3 id="WKWebView与原生JS交互"><a href="#WKWebView与原生JS交互" class="headerlink" title="WKWebView与原生JS交互"></a>WKWebView与原生JS交互</h3><p>采用<code>WKWebView</code>与原生JS交互的原因在于<code>WKWebView</code>相比于<code>UIWebView</code>，其与JS交互的能力明显增强，并且在加载速度及内存占用上都有显著提升。<code>WKWebView</code>与JS交互主要依赖于两个概念：user scripts和script messages。</p>
<p>先说user scripts。简单来说，它是在<code>WKWebView</code>加载时被注入到web页面中的JS代码块。当然，user scripts也可以在页面内容(DOM)加载完成之前或者加载完成之后注入和运行。user scripts可以做到JS在页面中能做到的所有事情，包括操作DOM和调用页面中存在的已加载的任何JS方法。user scripts是原生app调用JS的方式。</p>
<p>再说script messages。script messages是web页面调用原生app的方式。一个script message与页面中的JS方法绑定，你需要在原生app中定义处理方法来负责处理web页面传过来的消息。script message可以由user script或者任何其他加载进页面的脚本触发。</p>
<p>以下我会以一个小demo来说明<code>WKWebView</code>与JS如何交互的。在demo中我要做到的是如何通过再原生app中调用JS方法来改变DOM元素的颜色并且同时监听html页面中的JS发送给原生app的异步消息。</p>
<p>为了能让web页面和<code>WKWebView</code>交互，我们需要两个主要的元素：</p>
<blockquote>
<p>1.带有可以被<code>WKWebView</code>加载的JS代码的web页面<br>2.可以与web页面进行通信交互的<code>WKWebView</code>原生app</p>
</blockquote>
<h5 id="Web页面"><a href="#Web页面" class="headerlink" title="Web页面"></a>Web页面</h5><p>web页面的构成很简单，包含两个文件：index.html和main.js，index.html是页面文件，main.js被index.html调用。main.js文件的内容如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">callNativeApp</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        webkit.messageHandlers.callbackHandler.postMessage(<span class="string">"Hello from JavaScript"</span>);</div><div class="line">    &#125; <span class="keyword">catch</span>(err) &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'The native context does not exist yet'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    callNativeApp();</div><div class="line">&#125;, <span class="number">5000</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">redHeader</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">document</span>.querySelector(<span class="string">'h1'</span>).style.color = <span class="string">"red"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当这段脚本代码被加载时，它会延迟5秒后调用<code>callNativeApp</code>方法。我们要注意的是”callbackHandler”，这是我们后面在原生app中定义的script message handler的名字。另外，我将回调”webkit.messageHandlers…..”封装进try-catch中来避免当脚本不再原生app的context下运行时会产生错误。最后还有一个改变html页面中h1标签颜色为红色的方法，后面我们会用到它。我将从本地服务器去加载它来模拟更真实的环境。</p>
<h5 id="原生app"><a href="#原生app" class="headerlink" title="原生app"></a>原生app</h5><p>关于<code>WKWebView</code>的使用在此就不赘述了，不了解的可以查阅苹果相关文档。首先我们要做的是创建<code>WKWebView</code>对象并指定测试的URL地址。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">self</span>.webView = <span class="type">WKWebView</span>()</div><div class="line"><span class="keyword">var</span> url = <span class="type">NSURL</span>(string:<span class="string">"http://localhost/WKJSDemo/"</span>)</div><div class="line"><span class="keyword">var</span> req = <span class="type">NSURLRequest</span>(<span class="type">URL</span>:url)</div><div class="line"><span class="keyword">self</span>.webView!.loadRequest(req)</div></pre></td></tr></table></figure>
<h5 id="原生app调用JS"><a href="#原生app调用JS" class="headerlink" title="原生app调用JS"></a>原生app调用JS</h5><p><code>WKWebView</code>的初始化方法有一个参数叫configuration，接收的是<code>WKWebViewConfiguration</code>实例，通过这个实例我们可以设置webView是否开启调用JS。这里我们需要设置的是<code>WKWebViewConfiguration</code>的<code>userContentController</code>属性。这个属性接收<code>WKUserContentController</code>实例。该实例有个方法叫做<code>addUserScript</code>，我们调用该方法添加user script。下面给出示例代码：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> contentController = <span class="type">WKUserContentController</span>();</div><div class="line"><span class="keyword">var</span> userScript = <span class="type">WKUserScript</span>(</div><div class="line">    source: <span class="string">"redHeader()"</span>,</div><div class="line">    injectionTime: <span class="type">WKUserScriptInjectionTime</span>.<span class="type">AtDocumentEnd</span>,</div><div class="line">    forMainFrameOnly: <span class="literal">true</span></div><div class="line">)</div><div class="line">contentController.addUserScript(userScript)</div><div class="line"></div><div class="line"><span class="keyword">var</span> config = <span class="type">WKWebViewConfiguration</span>()</div><div class="line">config.userContentController = contentController</div><div class="line"><span class="keyword">self</span>.webView = <span class="type">WKWebView</span>(</div><div class="line">    frame: <span class="keyword">self</span>.containerView.bounds,</div><div class="line">    configuration: config</div><div class="line">)</div></pre></td></tr></table></figure>
<p>在<code>WKUserScript</code>初始化方法中<code>redHeader()</code>对应的JS文件中的同名方法。”injectionTime”参数告诉user script当HTML页面的body加载完时运行脚本代码。”forMainFrameOnly”参数是说脚本只会被注入HTML页面的主帧中。</p>
<p>现在我们运行代码，就会发现HTML页面的头部文字是红色的。</p>
<h5 id="JS调用原生app"><a href="#JS调用原生app" class="headerlink" title="JS调用原生app"></a>JS调用原生app</h5><p>我们已经知道原生app中如何调用JS代码，那么JS如何调用原生app呢？正如我们之前说过的，这要用到”script messages”。</p>
<p>为了能接收到来自JS的事件，控制器需要遵守<code>WKScriptMessageHandler</code>协议。这意味着两点，我们要继承<code>WKScriptMessageHandler</code>并且实现<code>userContentController</code>的代理方法。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">userContentController</span><span class="params">(userContentController: WKUserContentController!, didReceiveScriptMessage message: WKScriptMessage!)</span></span> &#123;</div><div class="line">    <span class="keyword">if</span>(message.name == <span class="string">"callbackHandler"</span>) &#123;</div><div class="line">        <span class="built_in">println</span>(<span class="string">"JavaScript is sending a message \(message.body)"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们注意到代理方法会检查消息的名字是否为”callbackHandler”，回想之前的JS代码中有一行是这样的：”webkit.messageHandlers.callbackHandler.postMessage…”。原生app的方法会检查接收到的script message是否是想要的，如果是想要的，则在控制台打印消息的所有信息。</p>
<p>接下来，我们需要告诉webview开始监听来自JS的事件。这需要我们给<code>contentController</code>添加”script handler”。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">contentController.addScriptMessageHandler( <span class="keyword">self</span>, name: <span class="string">"callbackHandler"</span>)</div></pre></td></tr></table></figure>
<p>第一个参数self是指script message的代理是<code>ViewController</code>。如果你想在另一个类中处理接收到的消息，需要将该类的实例传入。第二个参数传入的是在JS中调用原生<code>userContentController</code>代理方法的名字。</p>
<p>写完后编译运行，5秒后控制台会打印出信息。</p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">// index.html</div><div class="line"></div><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></div><div class="line">            body &#123;</div><div class="line">                padding-top: 40px; </div><div class="line">            &#125;</div><div class="line">        <span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>WKWebView Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>WKWebView Test<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"main.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// main.js</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">callNativeApp</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        webkit.messageHandlers.callbackHandler.postMessage(<span class="string">"Hello from JavaScript"</span>);</div><div class="line">    &#125; <span class="keyword">catch</span>(err) &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'The native context does not exist yet'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    callNativeApp();</div><div class="line">&#125;, <span class="number">5000</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">redHeader</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">document</span>.querySelector(<span class="string">'h1'</span>).style.color = <span class="string">"red"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ViewController.swift</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> UIKit</div><div class="line"><span class="keyword">import</span> WebKit</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewController</span>: <span class="title">UIViewController</span>, <span class="title">WKScriptMessageHandler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">var</span> containerView : <span class="type">UIView</span>! = <span class="literal">nil</span></div><div class="line">    <span class="keyword">var</span> webView: <span class="type">WKWebView</span>?</div><div class="line">                            </div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">loadView</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">super</span>.loadView()</div><div class="line">        <span class="keyword">var</span> contentController = <span class="type">WKUserContentController</span>();</div><div class="line">        <span class="keyword">var</span> userScript = <span class="type">WKUserScript</span>(source: <span class="string">"redHeader()"</span>, injectionTime: <span class="type">WKUserScriptInjectionTime</span>.<span class="type">AtDocumentEnd</span>, forMainFrameOnly: <span class="literal">true</span></div><div class="line">        )</div><div class="line">        contentController.addUserScript(userScript)</div><div class="line">        contentController.addScriptMessageHandler( <span class="keyword">self</span>, name: <span class="string">"callbackHandler"</span>)</div><div class="line">        <span class="keyword">var</span> config = <span class="type">WKWebViewConfiguration</span>()</div><div class="line">        config.userContentController = contentController</div><div class="line">        <span class="keyword">self</span>.webView = <span class="type">WKWebView</span>(frame: <span class="keyword">self</span>.containerView.bounds,configuration: config)</div><div class="line">        <span class="keyword">self</span>.view = <span class="keyword">self</span>.webView!</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">super</span>.viewDidLoad()</div><div class="line">        <span class="keyword">var</span> url = <span class="type">NSURL</span>(string:<span class="string">"http://localhost/~jornki/tests/WKDemo/"</span>)</div><div class="line">        <span class="keyword">var</span> req = <span class="type">NSURLRequest</span>(<span class="type">URL</span>:url)</div><div class="line">        <span class="keyword">self</span>.webView!.loadRequest(req)</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">userContentController</span><span class="params">(userContentController: WKUserContentController!, didReceiveScriptMessage message: WKScriptMessage!)</span></span> &#123;</div><div class="line">        <span class="keyword">if</span>(message.name == <span class="string">"callbackHandler"</span>) &#123;</div><div class="line">            <span class="built_in">println</span>(<span class="string">"JavaScript is sending a message \(message.body)"</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
    

    
</div>


                

                <!-- Post Comments -->
                
                    




                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2016/07/18/iOS 10 UICollectionView新特性小记/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2016/05/17/H5游戏接入技术小结（上）/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="zakariyyasv's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        zakariyyasv@gmail.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/" target="_self">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2016/10/">十月 2016<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/09/">九月 2016<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/08/">八月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/07/">七月 2016<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/05/">五月 2016<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/04/">四月 2016<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/03/">三月 2016<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/02/">二月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/01/">一月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/12/">十二月 2015<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/10/">十月 2015<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/09/">九月 2015<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/twitter" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-twitter.png);">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/facebook" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-facebook.png);">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-gplus.png);">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/ZakariyyaSv" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.png);">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;
            <script type="text/javascript">
                var fd = new Date();
                document.write(fd.getFullYear());
            </script>
            &nbsp;zakariyyasv's blog
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->
<script src="/js/lazyload.min.js"></script>
<script src="/js/js.min.js"></script>
<script src="/js/nprogress.js"></script>

<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>













<!-- Swiftye -->


<!-- Local Search-->


<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->


                </main>
            </div>
        </body>
    
</html>
