<!DOCTYPE html>
<html lang="zh">
    <head>
    <!-- 
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.3.0 -->

    <!-- Title -->
    
    <title>
        
            H5游戏接入技术小结（上） | 
        
        zakariyyasv&#39;s blog
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!-- Meta & Info -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="zakariyyasv">
    <meta name="description" content="Just forcus">
    <meta name="keywords" content="null">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="zakariyyasv&#39;s blog">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://zakariyyasv.pub">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="H5游戏接入技术小结（上） | zakariyyasv&#39;s blog">
    <meta property="og:description" content="Just forcus">
    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.en.js"></script>
        
    <![endif]-->

    <!-- Import CSS -->
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="/css/style.min.css">
    <!-- Config CSS -->


<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }
</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>



    <script src="/js/jquery.min.js"></script>
    <script src="/js/queue.js"></script>

    <!-- UC Browser Compatible -->
    <script>
        var agent = navigator.userAgent.toLowerCase();
        if(agent.indexOf('ucbrowser')>0) {
            document.write("<link rel=\"stylesheet\" href=\"/css/uc.css\">");
            alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
        }
    </script>

    

    

    <!-- Bing Background -->
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#概览"><span class="post-toc-number">1.</span> <span class="post-toc-text">概览</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#游戏资源下载思路"><span class="post-toc-number">2.</span> <span class="post-toc-text">游戏资源下载思路</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#游戏资源下载的代码实现"><span class="post-toc-number">3.</span> <span class="post-toc-text">游戏资源下载的代码实现</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#结语"><span class="post-toc-number">4.</span> <span class="post-toc-text">结语</span></a></li></ol>

        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script>
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').css('background-image', 'url(' + '/img/random/material-' + randomNum + '.png' + ')');
</script>

        
    
            <p class="article-headline-p">
                H5游戏接入技术小结（上）
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>zakariyyasv</strong>
        <span>5月 17, 2016</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=H5游戏接入技术小结（上）&url=http://zakariyyasv.pub//2016/05/17/H5游戏接入技术小结（上）/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=H5游戏接入技术小结（上）&url=http://zakariyyasv.pub//2016/05/17/H5游戏接入技术小结（上）/index.html&via=zakariyyasv" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://zakariyyasv.pub//2016/05/17/H5游戏接入技术小结（上）/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://zakariyyasv.pub//2016/05/17/H5游戏接入技术小结（上）/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h3 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h3><p>这段时间忙着做游戏平台H5游戏的接入，趁着刚做完还热乎劲儿，将其中的技术要点总结下来。H5游戏的接入主要分为两个部分：游戏的下载和游戏对战。本篇博客着重讲述游戏的下载部分，下篇博客将着重讲述H5游戏与app通过JS进行数据交互以及在线对战的技术要点。</p>
<p>H5游戏资源本质上是由一些目录以及目录下的文件资源组成，要能够在app中运行H5游戏，就是要在<code>WKWebView</code>的浏览器中用HTTPServer搭建本地服务，然后去加载游戏资源根目录下的index.html文件，换句话说index.html文件是游戏的入口文件。<a id="more"></a>HTTPServer我们采用的是开源的<a href="https://github.com/robbiehanson/CocoaHTTPServer" target="_blank" rel="external">CocoaHTTPServer</a>，关于在app中搭建HTTPServer服务的内容就不多赘述，感兴趣的可以去Github上了解。当然，这也需要H5与iOS开发人员沟通和调试才能真正地在<code>WKWebView</code>中流畅运行。</p>
<h3 id="游戏资源下载思路"><a href="#游戏资源下载思路" class="headerlink" title="游戏资源下载思路"></a>游戏资源下载思路</h3><p>知道了怎样在app中运行H5游戏，接下来最重要的就是游戏资源的下载。当用户进入一个游戏后，游戏的状态分为三种：未下载，已下载，暂停下载和需要更新。如何判断游戏此时的状态呢？首先我们需要区分每一个游戏，因此，约定将游戏资源的URL进行MD5加密后的字符串作为游戏的唯一标识符。之后，我们创建<code>game.plist</code>文件，文件中存储一个字典，字典的key为游戏的标识符，value为游戏资源的大小。每当一个游戏开始下载，则在plist文件中添加一条记录。检查游戏的状态时，拿游戏的标识符与plist文件中所有的记录进行对比，若未找到相同的记录则状态为未下载。否则，在存储游戏资源的文件夹中查找以游戏标识符命名的.zip压缩包，若找到将其包的大小与plist文件中找到的记录的大小进行比较，若大小不同，则状态为暂停下载，若未找到压缩包且未找到解压后的资源文件夹显示为未下载。否则，状态为已下载。至于更新的状态则需要与服务器端进行沟通和约定，在此就不讲了。</p>
<p><img src="/images/h5game/1.png" alt=""></p>
<p>确定完当前进入游戏的状态后，当游戏处于未下载或者暂停的状态时，用户可以点击下载按钮进行下载。下载的过程分为两种情况：未下载开始下载和暂停继续下载。第一种情况的下载过程是这样：在资源下载目录下创建以游戏标识符命名的.zip压缩文件，用<code>NSURLSession</code>创建<code>NSURLSessionDataTask</code>任务负责资源数据的接收，用<code>NSOutputStream</code>负责数据流的写入工作。写入完毕后，关闭<code>NSOutputStream</code>服务，验证资源包数据的完整性。若资源包数据完整，则对其进行解压缩，得到游戏运行的全部资源文件后便可以开始游戏。第二种情况则是在资源下载目录下查找以游戏标识符命名的.zip压缩包，获取包文件的内容大小，将其放入<code>NSURLRequest</code>的HTTP请求头中，剩下的步骤与第一种情况相同。</p>
<p><img src="/images/h5game/2.png" alt=""></p>
<h3 id="游戏资源下载的代码实现"><a href="#游戏资源下载的代码实现" class="headerlink" title="游戏资源下载的代码实现"></a>游戏资源下载的代码实现</h3><p>思路厘清了，就需要用代码去实现它。因此，我创建了名为<code>XRDownloadManger</code>的类负责游戏资源的下载工作。为了更好的辅助<code>XRDownloadManager</code>工作，又创建了模型类<code>XRSessionModel</code>来存储游戏资源的相关数据。</p>
<p>下面列出的是<code>XRSessionModel</code>的类结构：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// XRSessionModel.h</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</div><div class="line">    DownloadStateStart = <span class="number">0</span>,     <span class="comment">/** 下载中 */</span></div><div class="line">    DownloadStateSuspended,     <span class="comment">/** 下载暂停 */</span></div><div class="line">    DownloadStateCompleted,     <span class="comment">/** 下载完成 */</span></div><div class="line">    DownloadStateFailed         <span class="comment">/** 下载失败 */</span></div><div class="line">&#125;DownloadState;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">XRSessionModel</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="comment">/** 流 */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSOutputStream</span> *stream;</div><div class="line"><span class="comment">/** 下载地址 */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *url;</div><div class="line"><span class="comment">/** 游戏版本号*/</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *update;</div><div class="line"><span class="comment">/** 获得服务器这次请求 返回数据的总长度 */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> totalLength;</div><div class="line"><span class="comment">/** 下载进度 */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="keyword">void</span>(^progressBlock)(<span class="built_in">NSInteger</span> receivedSize, <span class="built_in">NSInteger</span> expectedSize, <span class="built_in">CGFloat</span> progress);</div><div class="line"><span class="comment">/** 下载状态 */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="keyword">void</span>(^stateBlock)(DownloadState state);</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p><code>XRDownloadManger</code>采用了单例设计模式，该类主要的工作包括开启任务下载游戏资源并回调下载进度和下载状态，获取资源大小，删除已下载资源，判断游戏资源是否下载完成等。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">XRDownloadManager</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  单例</div><div class="line"> *  @return 返回单例对象</div><div class="line"> */</div><div class="line">+ (<span class="keyword">instancetype</span>)sharedInstance;</div><div class="line"><span class="comment">/**</span></div><div class="line"> *  开启任务下载资源</div><div class="line"> *  @param url           下载地址</div><div class="line"> *  @param progressBlock 回调下载进度</div><div class="line"> *  @param stateBlock    下载状态</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)download:(<span class="built_in">NSString</span> *)url update:(<span class="built_in">NSString</span> *)update progress:(<span class="keyword">void</span>(^)(<span class="built_in">NSInteger</span> receivedSize, <span class="built_in">NSInteger</span> expectedSize, <span class="built_in">CGFloat</span> progress))progressBlock state:(<span class="keyword">void</span>(^)(DownloadState state))stateBlock;</div><div class="line"><span class="comment">/**</span></div><div class="line"> *  查询该资源的下载进度值</div><div class="line"> *  @param url 下载地址</div><div class="line"> *  @return 返回下载进度值</div><div class="line"> */</div><div class="line">- (<span class="built_in">CGFloat</span>)progress:(<span class="built_in">NSString</span> *)url;</div><div class="line"><span class="comment">/**</span></div><div class="line"> *  获取该资源总大小</div><div class="line"> *  @param url 下载地址</div><div class="line"> *  @return 资源总大小</div><div class="line"> */</div><div class="line">- (<span class="built_in">NSInteger</span>)fileTotalLength:(<span class="built_in">NSString</span> *)url;</div><div class="line"><span class="comment">/**</span></div><div class="line"> *  判断该资源是否下载完成</div><div class="line"> *  @param url 下载地址</div><div class="line"> *  @return YES: 完成</div><div class="line"> */</div><div class="line">- (<span class="built_in">BOOL</span>)isCompletion:(<span class="built_in">NSString</span> *)url;</div><div class="line"><span class="comment">/**</span></div><div class="line"> *  删除该资源</div><div class="line"> *  @param url 下载地址</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)deleteFile:(<span class="built_in">NSString</span> *)url;</div><div class="line"><span class="comment">/**</span></div><div class="line"> *  清空所有下载资源</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)deleteAllFile;</div><div class="line"><span class="comment">/**</span></div><div class="line"> *  根据下载地址查找该资源路径</div><div class="line"> **/</div><div class="line">- (<span class="built_in">NSString</span> *)getPathWithUrl:(<span class="built_in">NSString</span> *)url;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p><code>XRDownloadManger</code>实现文件中包含两个可变字典类型的成员变量<code>tasks</code>和<code>sessionModels</code>，<code>tasks</code>负责保存所有的下载任务，<code>sessionModels</code>负责保存所有的下载资源的相关信息。<code>tasks</code>和<code>sessionModels</code>均是以url为key，但value分别为<code>NSURLSessionDataTask</code>和<code>XRSessionModel</code>的键值对。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSMutableDictionary</span> *)tasks&#123;</div><div class="line">    <span class="keyword">if</span> (!_tasks) &#123;</div><div class="line">        _tasks = [<span class="built_in">NSMutableDictionary</span> dictionary];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> _tasks;</div><div class="line">&#125;</div><div class="line">- (<span class="built_in">NSMutableDictionary</span> *)sessionModels&#123;</div><div class="line">    <span class="keyword">if</span> (!_sessionModels) &#123;</div><div class="line">        _sessionModels = [<span class="built_in">NSMutableDictionary</span> dictionary];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> _sessionModels;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>download:::</code>方法是负责下载的主要方法。每一个<code>NSURLSessionDataTask</code>对象负责一个游戏资源的下载，并将该对象存入tasks中。当下载完成并验证压缩包内容的完整性后将<code>NSURLSessionDataTask</code>对象移除，当需要暂停的时候，以游戏URL的md5字符串为key拿到<code>NSURLSessionDataTask</code>对象并执行suspend方法将下载任务暂停。暂停后继续下载也与之类似，同样是从tasks中拿到<code>NSURLSessionDataTask</code>对象并执行resume方法继续下载任务。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> *  开启任务下载资源</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)download:(<span class="built_in">NSString</span> *)url update:(<span class="built_in">NSString</span> *)update progress:(<span class="keyword">void</span> (^)(<span class="built_in">NSInteger</span>, <span class="built_in">NSInteger</span>, <span class="built_in">CGFloat</span>))progressBlock state:(<span class="keyword">void</span> (^)(DownloadState))stateBlock</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!url) <span class="keyword">return</span>;</div><div class="line">    <span class="comment">// 判断资源是否下载完成</span></div><div class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> isCompletion:url]) &#123;</div><div class="line">        stateBlock(DownloadStateCompleted);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 暂停下载</span></div><div class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.tasks valueForKey:XRFileName(url)]) &#123;</div><div class="line">        [<span class="keyword">self</span> handle:url];</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 创建缓存目录文件</span></div><div class="line">    [<span class="keyword">self</span> createCacheDirectory];</div><div class="line">   <span class="built_in">NSURLSession</span> *session = [<span class="built_in">NSURLSession</span> sessionWithConfiguration:[<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration] delegate:<span class="keyword">self</span> delegateQueue:[[<span class="built_in">NSOperationQueue</span> alloc] init]];</div><div class="line">    <span class="comment">// 创建流</span></div><div class="line">    <span class="built_in">NSOutputStream</span> *stream = [<span class="built_in">NSOutputStream</span> outputStreamToFileAtPath:XRFileFullpath(url) append:<span class="literal">YES</span>];</div><div class="line">    <span class="comment">// 创建URL请求</span></div><div class="line">    <span class="built_in">NSMutableURLRequest</span> *request = [<span class="built_in">NSMutableURLRequest</span> requestWithURL:[<span class="built_in">NSURL</span> URLWithString:url]];</div><div class="line">    <span class="comment">// 设置下载内容范围的请求头</span></div><div class="line">    <span class="built_in">NSString</span> *range = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"bytes=%zd-"</span>, XRDownloadLength(url)];</div><div class="line">    [request setValue:range forHTTPHeaderField:<span class="string">@"Range"</span>];</div><div class="line">    <span class="comment">// 创建一个Data任务</span></div><div class="line">    <span class="built_in">NSURLSessionDataTask</span> *task = [session dataTaskWithRequest:request];</div><div class="line">    <span class="built_in">NSUInteger</span> taskIdentifier = arc4random() % ((arc4random() % <span class="number">10000</span> + arc4random() % <span class="number">10000</span>));</div><div class="line">    [task setValue:@(taskIdentifier) forKeyPath:<span class="string">@"taskIdentifier"</span>];</div><div class="line">    <span class="comment">// 保存任务</span></div><div class="line">    [<span class="keyword">self</span>.tasks setValue:task forKey:XRFileName(url)];</div><div class="line">    XRSessionModel *sessionModel = [[XRSessionModel alloc] init];</div><div class="line">    sessionModel.url = url;</div><div class="line">    sessionModel.update = update;</div><div class="line">    sessionModel.progressBlock = progressBlock;</div><div class="line">    sessionModel.stateBlock = stateBlock;</div><div class="line">    sessionModel.stream = stream;</div><div class="line">    [<span class="keyword">self</span>.sessionModels setValue:sessionModel forKey:@(task.taskIdentifier).stringValue];</div><div class="line">    [<span class="keyword">self</span> start:url];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  判断该文件是否下载完成</div><div class="line"> */</div><div class="line">- (<span class="built_in">BOOL</span>)isCompletion:(<span class="built_in">NSString</span> *)url&#123;</div><div class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> fileTotalLength:url] &amp;&amp; XRDownloadLength(url) == [<span class="keyword">self</span> fileTotalLength:url]) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 若暂停则继续下载，若正在下载则暂停下载</span></div><div class="line">- (<span class="keyword">void</span>)handle:(<span class="built_in">NSString</span> *)url&#123;</div><div class="line">    <span class="built_in">NSURLSessionDataTask</span> *task = [<span class="keyword">self</span> getTask:url];</div><div class="line">    <span class="keyword">if</span> (task.state == <span class="built_in">NSURLSessionTaskStateRunning</span>) &#123;</div><div class="line">        [<span class="keyword">self</span> pause:url];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        [<span class="keyword">self</span> start:url];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  根据url获得对应的下载任务</div><div class="line"> */</div><div class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)getTask:(<span class="built_in">NSString</span> *)url&#123;</div><div class="line">    <span class="keyword">return</span> (<span class="built_in">NSURLSessionDataTask</span> *)[<span class="keyword">self</span>.tasks valueForKey:XRFileName(url)];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  开始下载</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)start:(<span class="built_in">NSString</span> *)url&#123;</div><div class="line">    <span class="built_in">NSURLSessionDataTask</span> *task = [<span class="keyword">self</span> getTask:url];</div><div class="line">    [task resume];</div><div class="line">    [<span class="keyword">self</span> getSessionModel:task.taskIdentifier].stateBlock(DownloadStateStart);</div><div class="line">    <span class="comment">// 删除暂停状态</span></div><div class="line">    <span class="built_in">NSFileManager</span> *fileManager = [<span class="built_in">NSFileManager</span> defaultManager];</div><div class="line">    <span class="keyword">if</span> ([fileManager fileExistsAtPath:XRPausePath]) &#123;</div><div class="line">        <span class="built_in">NSMutableDictionary</span> *dict = [<span class="built_in">NSMutableDictionary</span> dictionaryWithContentsOfFile:XRPausePath];</div><div class="line">        [dict removeObjectForKey:XRFileName(url)];</div><div class="line">        [dict writeToFile:XRPausePath atomically:<span class="literal">YES</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  暂停下载</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)pause:(<span class="built_in">NSString</span> *)url&#123;</div><div class="line">    <span class="built_in">NSURLSessionDataTask</span> *task = [<span class="keyword">self</span> getTask:url];</div><div class="line">    [task suspend];</div><div class="line">    [<span class="keyword">self</span> getSessionModel:task.taskIdentifier].stateBlock(DownloadStateSuspended);</div><div class="line">    <span class="comment">// 存储暂停状态</span></div><div class="line">    <span class="built_in">NSMutableDictionary</span> *dict = [<span class="built_in">NSMutableDictionary</span> dictionaryWithContentsOfFile:XRPausePath];</div><div class="line">    <span class="keyword">if</span> (dict == <span class="literal">nil</span>) dict = [<span class="built_in">NSMutableDictionary</span> dictionary];</div><div class="line">    dict[XRFileName(url)] = <span class="string">@"pause"</span>;</div><div class="line">    [dict writeToFile:XRPausePath atomically:<span class="literal">YES</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  根据url获取对应的下载信息模型</div><div class="line"> */</div><div class="line">- (XRSessionModel *)getSessionModel:(<span class="built_in">NSUInteger</span>)taskIdentifier&#123;</div><div class="line">    <span class="keyword">return</span> (XRSessionModel *)[<span class="keyword">self</span>.sessionModels valueForKey:@(taskIdentifier).stringValue];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  查询该资源的下载进度值</div><div class="line"> */</div><div class="line">- (<span class="built_in">CGFloat</span>)progress:(<span class="built_in">NSString</span> *)url&#123;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> fileTotalLength:url] == <span class="number">0</span> ? <span class="number">0.0</span> : <span class="number">1.0</span> * XRDownloadLength(url) /  [<span class="keyword">self</span> fileTotalLength:url];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  获取该资源总大小</div><div class="line"> */</div><div class="line">- (<span class="built_in">NSInteger</span>)fileTotalLength:(<span class="built_in">NSString</span> *)url&#123;</div><div class="line">    <span class="keyword">return</span> [[<span class="built_in">NSDictionary</span> dictionaryWithContentsOfFile:XRTotalLengthFullpath][XRFileName(url)] integerValue];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  根据下载地址查找该资源路径</div><div class="line"> **/</div><div class="line">-(<span class="built_in">NSString</span> *)getPathWithUrl:(<span class="built_in">NSString</span> *)url&#123;</div><div class="line">    <span class="built_in">NSString</span> *str = XRFileFullpath(url);</div><div class="line">    <span class="keyword">return</span> str;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>整个网络数据的请求和处理都依赖于<code>NSURLSessionDataDelegate</code>的代理方法。请求得到反馈时根据response拿到游戏资源的完整大小，并将其写入到<code>game.plist</code>文件中。当客户端开始接收服务器返回的数据时，打开<code>NSOutputStream</code>并开始将接收到的数据写入到指定路径下的文件中，并返回下载进度。接收数据完成后对数据包进行解压缩，解压成功则将写入流关闭并将下载任务从tasks中移除。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#pragma mark - NSURLSessionDataDelegate</span></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 接收到响应</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask didReceiveResponse:(<span class="built_in">NSHTTPURLResponse</span> *)response completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionResponseDisposition</span>))completionHandler&#123;</div><div class="line">    XRSessionModel *sessionModel = [<span class="keyword">self</span> getSessionModel:dataTask.taskIdentifier];</div><div class="line">    <span class="comment">// 打开流</span></div><div class="line">    [sessionModel.stream open];</div><div class="line">    <span class="comment">// 获得服务器这次请求 返回数据的总长度</span></div><div class="line">    <span class="built_in">NSInteger</span> totalLength = [response.allHeaderFields[<span class="string">@"Content-Length"</span>] integerValue] + XRDownloadLength(sessionModel.url);</div><div class="line">    sessionModel.totalLength = totalLength;</div><div class="line">    <span class="comment">// 存储总长度</span></div><div class="line">    <span class="built_in">NSMutableDictionary</span> *dict = [<span class="built_in">NSMutableDictionary</span> dictionaryWithContentsOfFile:XRTotalLengthFullpath];</div><div class="line">    <span class="keyword">if</span> (dict == <span class="literal">nil</span>) dict = [<span class="built_in">NSMutableDictionary</span> dictionary];</div><div class="line">    dict[XRFileName(sessionModel.url)] = @(totalLength);</div><div class="line">    [dict writeToFile:XRTotalLengthFullpath atomically:<span class="literal">YES</span>];</div><div class="line">    <span class="comment">// 接收这个请求，允许接收服务器的数据</span></div><div class="line">    completionHandler(<span class="built_in">NSURLSessionResponseAllow</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 接收到服务器返回的数据</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask didReceiveData:(<span class="built_in">NSData</span> *)data&#123;</div><div class="line">    XRSessionModel *sessionModel = [<span class="keyword">self</span> getSessionModel:dataTask.taskIdentifier];</div><div class="line">    <span class="comment">// 写入数据</span></div><div class="line">    [sessionModel.stream write:data.bytes maxLength:data.length];</div><div class="line">    <span class="comment">// 下载进度</span></div><div class="line">    <span class="built_in">NSUInteger</span> receivedSize = XRDownloadLength(sessionModel.url);</div><div class="line">    <span class="built_in">NSUInteger</span> expectedSize = sessionModel.totalLength;</div><div class="line">    <span class="built_in">CGFloat</span> progress = <span class="number">1.0</span> * receivedSize / expectedSize;</div><div class="line">    sessionModel.progressBlock(receivedSize, expectedSize, progress);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 请求完毕（成功|失败）</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session task:(<span class="built_in">NSURLSessionTask</span> *)task didCompleteWithError:(<span class="built_in">NSError</span> *)error&#123;</div><div class="line">    XRSessionModel *sessionModel = [<span class="keyword">self</span> getSessionModel:task.taskIdentifier];</div><div class="line">    <span class="keyword">if</span> (!sessionModel) <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> isCompletion:sessionModel.url]) &#123;</div><div class="line">        <span class="comment">//  下载完成，解压缩</span></div><div class="line">        [SSZipArchive unzipFileAtPath:XRFileFullpath(sessionModel.url) toDestination:XRWebDirectory];</div><div class="line">        sessionModel.stateBlock(DownloadStateCompleted);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error)&#123;</div><div class="line">        <span class="comment">// 下载失败</span></div><div class="line">        sessionModel.stateBlock(DownloadStateFailed);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 关闭流</span></div><div class="line">    [sessionModel.stream close];</div><div class="line">    sessionModel.stream = <span class="literal">nil</span>;</div><div class="line">    <span class="comment">// 清除任务</span></div><div class="line">    [<span class="keyword">self</span>.tasks removeObjectForKey:XRFileName(sessionModel.url)];</div><div class="line">    [<span class="keyword">self</span>.sessionModels removeObjectForKey:@(task.taskIdentifier).stringValue];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>以上是对下载过程实现的大概描述，其中的实现细节还有很多值得推敲和优化的地方，接下来会发时间去优化并会将优化后的效果总结出来。如果其中有错误的地方欢迎指正。</p>

    

    
</div>


                

                <!-- Post Comments -->
                
                    




                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2016/05/20/H5游戏接入技术小结（下）/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2016/04/23/庖丁解牛KVO（二）——KVO实现原理/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="zakariyyasv's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        zakariyyasv@gmail.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/" target="_self">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2016/10/">十月 2016<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/09/">九月 2016<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/08/">八月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/07/">七月 2016<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/05/">五月 2016<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/04/">四月 2016<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/03/">三月 2016<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/02/">二月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/01/">一月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/12/">十二月 2015<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/10/">十月 2015<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/09/">九月 2015<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/twitter" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-twitter.png);">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/facebook" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-facebook.png);">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-gplus.png);">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/ZakariyyaSv" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.png);">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;
            <script type="text/javascript">
                var fd = new Date();
                document.write(fd.getFullYear());
            </script>
            &nbsp;zakariyyasv's blog
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->
<script src="/js/lazyload.min.js"></script>
<script src="/js/js.min.js"></script>
<script src="/js/nprogress.js"></script>

<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>













<!-- Swiftye -->


<!-- Local Search-->


<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->


                </main>
            </div>
        </body>
    
</html>
