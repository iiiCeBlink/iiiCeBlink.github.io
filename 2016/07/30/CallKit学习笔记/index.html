<!DOCTYPE html>
<html lang="zh">
    <head>
    <!-- 
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.3.0 -->

    <!-- Title -->
    
    <title>
        
            CallKit学习笔记 | 
        
        zakariyyasv&#39;s blog
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!-- Meta & Info -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="zakariyyasv">
    <meta name="description" content="Just forcus">
    <meta name="keywords" content="null">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="zakariyyasv&#39;s blog">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://zakariyyasv.pub">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="CallKit学习笔记 | zakariyyasv&#39;s blog">
    <meta property="og:description" content="Just forcus">
    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.en.js"></script>
        
    <![endif]-->

    <!-- Import CSS -->
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="/css/style.min.css">
    <!-- Config CSS -->


<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }
</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>



    <script src="/js/jquery.min.js"></script>
    <script src="/js/queue.js"></script>

    <!-- UC Browser Compatible -->
    <script>
        var agent = navigator.userAgent.toLowerCase();
        if(agent.indexOf('ucbrowser')>0) {
            document.write("<link rel=\"stylesheet\" href=\"/css/uc.css\">");
            alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
        }
    </script>

    

    

    <!-- Bing Background -->
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#概览"><span class="post-toc-number">1.</span> <span class="post-toc-text">概览</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Architecture"><span class="post-toc-number">2.</span> <span class="post-toc-text">Architecture</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#CXProvider"><span class="post-toc-number">2.0.1.</span> <span class="post-toc-text">CXProvider</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#CXCallController"><span class="post-toc-number">2.0.2.</span> <span class="post-toc-text">CXCallController</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#Incoming-Call"><span class="post-toc-number">2.0.3.</span> <span class="post-toc-text">Incoming Call</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#Call-Actions"><span class="post-toc-number">2.0.4.</span> <span class="post-toc-text">Call Actions</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#Multiple-Call"><span class="post-toc-number">2.0.5.</span> <span class="post-toc-text">Multiple Call</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#Outgoing-Call"><span class="post-toc-number">2.0.6.</span> <span class="post-toc-text">Outgoing Call</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#API-Details"><span class="post-toc-number">3.</span> <span class="post-toc-text">API Details</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#Authorization"><span class="post-toc-number">3.0.1.</span> <span class="post-toc-text">Authorization</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#Provider-Configuration"><span class="post-toc-number">3.0.2.</span> <span class="post-toc-text">Provider Configuration</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#Actions-Error"><span class="post-toc-number">3.0.3.</span> <span class="post-toc-text">Actions Error</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#System-Restrictions"><span class="post-toc-number">3.0.4.</span> <span class="post-toc-text">System Restrictions</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#Audio"><span class="post-toc-number">3.0.5.</span> <span class="post-toc-text">Audio</span></a></li></ol></li></ol></li></ol>

        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script>
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').css('background-image', 'url(' + '/img/random/material-' + randomNum + '.png' + ')');
</script>

        
    
            <p class="article-headline-p">
                CallKit学习笔记
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>zakariyyasv</strong>
        <span>7月 30, 2016</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=CallKit学习笔记&url=http://zakariyyasv.pub//2016/07/30/CallKit学习笔记/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=CallKit学习笔记&url=http://zakariyyasv.pub//2016/07/30/CallKit学习笔记/index.html&via=zakariyyasv" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://zakariyyasv.pub//2016/07/30/CallKit学习笔记/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://zakariyyasv.pub//2016/07/30/CallKit学习笔记/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h3 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h3><p>近几年4G大规模的普及使得VoIP（Voice over Internet Protocol）变得可靠和稳定。iOS 10开始全面支持VOIP，于是推出了<code>CallKit</code>框架。</p>
<p><code>CallKit</code>框架能让你的第三方VoIP应用程序获得原声应用程序的体验效果。为了能更好得讲述<code>CallKit</code>新特性，我们以一个第三方VoIP应用程序——“Speakerbox”举例来说明。<br><a id="more"></a><br>在iOS 10之前，当用户收到“Speakerbox”的电话时的界面如同下图。在锁屏状态下，我们无法区分iMessage和VoIP电话的区别，它只是一则通知。如果想要接听“Speakerbox”中的来电，我们需要先右滑通知，输入密码，进入app才能接听电话。这是非常糟糕的体验。而在解锁状态下，来电会显示为一条横幅，我们有时候可能会错过这些通知，这样的体验也是很糟糕的。</p>
<p><img src="/images/callkit/1.png" alt=""></p>
<p><img src="/images/callkit/2.png" alt=""></p>
<p>在iOS 10中，“Speakerbox”可以像原生电话UI那样接听和显示VoIP通话。</p>
<p><img src="/images/callkit/3.png" alt=""></p>
<p><img src="/images/callkit/4.png" alt=""></p>
<p><img src="/images/callkit/5.png" alt=""></p>
<h3 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h3><p>在iOS 10以前，像系统服务如蓝牙、Siri、CarPlay与VoIP的应用程序如“Speakerbox”是相互独立的两部分。在iOS 10中，通过<code>CallKit</code>框架可以将两者连接起来，现在在“Speakerbox”上发起的通信电话可以被系统获取然后系统会与目的设备之间建立起通信。</p>
<p><img src="/images/callkit/6.png" alt=""></p>
<p>现在我们进一步来聊聊“Speakerbox”。在下图中，我们有“Speakerbox”以及它所有的代码，它与网络进行通信并有自己的UI。接下来，我们要与<code>CallKit</code>连接。这里有两个类需要我们着重去注意，分别是<code>CXProvider</code>和<code>CXCallController</code>。</p>
<blockquote>
<h5 id="CXProvider"><a href="#CXProvider" class="headerlink" title="CXProvider"></a>CXProvider</h5><p>Out-of-band nontifications<br>Not user actions<br>External events</p>
<ul>
<li>incoming calls</li>
</ul>
<h5 id="CXCallController"><a href="#CXCallController" class="headerlink" title="CXCallController"></a>CXCallController</h5><p>Requests from app<br>Local user actions<br>Internal events</p>
<ul>
<li>Start call</li>
</ul>
</blockquote>
<p><code>CXProvider</code>的作用是告知系统所有的带外（out-of-band）通知信息。带外通知的意思是指非用户操作而是外在真实发生的事件，比如来电（incoming call）。</p>
<p><code>CXCallController</code>的作用是让系统感知来自于app自身的请求。这里的请求是真实的用户操作就像内部事件，如开始通话操作。<code>CXCallController</code>会与系统上其他的通话产生相互影响。例如，用户已经处于通话状态了，而他还想通过“Speakerbox”再开启一个通话。这时候<code>CXCallController</code>会告诉系统用户的开启通话的操作，系统会告知通话提供者保持当前的通话，这样可以让“Speakerbox”开始它的通话。</p>
<p>所以，当<code>CXProvider</code>想与系统进行通信时它会使用<code>CSXCallUpdate</code>类，当系统想让“Speakerbox”接收用户操作，它会使用<code>CXAction</code>类来让“Speakerbox”知道。<code>CXCallController</code>会将这些用户操作装进<code>CSTransaction</code>对象中来告知系统用户产生的操作。</p>
<p><img src="/images/callkit/7.png" alt=""></p>
<p>现在我们来看看来电的整体工作流程。现在比如说一个叫做Jane的人收到了来自他妈妈的来电通话请求。“Speakerbox”收到了来电，然后会创建<code>CXCallUpdate</code>对象并通过<code>CXProvider</code>发送给系统。接着，系统将来电告知包括UI的所有服务。如果Jane想应答，Jane可以通过通话界面的应答按钮接通通话。这时候系统会告诉“Speakerbox”只要它需要随时可以接通来电通话。如果Jane想通过操作app的UI来结束通话，<code>CXCallController</code>会将结束action打包进一个<code>CXTransaction</code>对象中并将其发送给系统。如果一切ok，系统会通过<code>CXProvider</code>将其发送给“Speakerbox”，这样“Speakerbox”就可以随时结束通话。</p>
<p><img src="/images/callkit/8.png" alt=""></p>
<p><img src="/images/callkit/9.png" alt=""></p>
<h5 id="Incoming-Call"><a href="#Incoming-Call" class="headerlink" title="Incoming Call"></a>Incoming Call</h5><p>下面以代码的形式简要概述来电发生的过程：</p>
<p>1.将来电信息通知到系统<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">provider.reportNewIncomingCall(with: <span class="type">UUID</span>, update: <span class="type">CXCallUpdate</span>) &#123; error <span class="keyword">in</span> <span class="comment">/* ... */</span> &#125;</div></pre></td></tr></table></figure></p>
<p>2.用户点击通话按钮进行通话，<code>ProviderDelegate</code>会调用<code>PerformAnswerCallAction</code>方法。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">provider</span><span class="params">(<span class="number">_</span> provider: CXProvider, perform action: CXAnswerCallAction)</span></span> &#123; <span class="comment">/* ... */</span> &#125;</div></pre></td></tr></table></figure></p>
<p>3.当用户真正地在通话时，<code>CXAnswerCallAction</code>会执行<code>fulfill</code>方法。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">answerCallAction.fulfill()</div></pre></td></tr></table></figure></p>
<h5 id="Call-Actions"><a href="#Call-Actions" class="headerlink" title="Call Actions"></a>Call Actions</h5><p>以下列出了所有的callAction类型：</p>
<blockquote>
<ul>
<li>CXAnswerCallAction</li>
<li>CXStartCallAction</li>
<li>CXEndCallAction</li>
<li>CXSetHeldCallAction</li>
<li>CXSetGroupCallAction</li>
<li>CXPlayDTMFCallAction</li>
<li>CXSetMutedCallAction</li>
</ul>
</blockquote>
<h5 id="Multiple-Call"><a href="#Multiple-Call" class="headerlink" title="Multiple Call"></a>Multiple Call</h5><p>接下来花点时间讲讲多来电通话时的管理。例如，现在“Speakerbox”已经处于通话状态了，这时候又有一个通话请求进来。</p>
<p><img src="/images/callkit/11.png" alt=""></p>
<p>如果用户想要结束现在进行的通话并且回应刚进来的通话时，系统会给“Speakerbox”发送<code>CXTransaction</code>。<code>CXTransaction</code>只是一个或多个action组合起来的集合，在现在这种情况下它就是<code>end</code>和<code>answer</code>操作的集合。一旦“Speakerbox”处理并执行集合中的action，系统就会了解到并且换UI。</p>
<p><img src="/images/callkit/12.png" alt=""></p>
<h5 id="Outgoing-Call"><a href="#Outgoing-Call" class="headerlink" title="Outgoing Call"></a>Outgoing Call</h5><p>再来看看去电的流程。要拨出电话首先要找到你需要联系的联系人再进行操作发起通话请求（start call intent）。intent是代表用户意愿操作的对象，被打包成<code>NSUser activity</code>后传回你的app中。app接收到开始通话的intent然后在intent信息的基础上构建开始通话action。我们通过<code>CallController</code>来执行和请求action，之后，<code>CallController</code>会将action传递给系统。如果通话请求被接受了，action会通过<code>ProviderDelegate</code>返回你的app中。最后，app通过网络执行必要的命令建立起通话连接。</p>
<p><img src="/images/callkit/13.png" alt=""></p>
<p>我们来看下整个去电的生命周期。我们以执行开始通话操作为起始点。这时候通话处于starting状态，之后，我们会执行完action操作并将通话状态变成started。当通话的另一端响应通话时，我们会通知provider通话已经开始连接（connecting）。最后，我们告诉provider通话已经连接上了（connected）来通知系统两端可以开始互相说话。</p>
<p><img src="/images/callkit/14.png" alt=""></p>
<p>最后我们以代码的形式来简要回顾一下去电的流程：</p>
<p>1.通过<code>CallController</code>请求开始通话action<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">callController.request(startCallTransaction) &#123; error <span class="keyword">in</span> <span class="comment">/* ... */</span> &#125;</div></pre></td></tr></table></figure></p>
<p>2.action通过<code>ProviderDelegate</code>被接受，然后执行。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">startCallAction.fulfill()</div></pre></td></tr></table></figure></p>
<p>3.app通知call将其状态从connecting转变成connected。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">provider.reportOutgoingCall(with: call.uuid, startedConnectingAt: call.connectingDate)</div><div class="line">provider.reportOutgoingCall(with: call.uuid, connectedAt: call.connectDate)</div></pre></td></tr></table></figure></p>
<h3 id="API-Details"><a href="#API-Details" class="headerlink" title="API Details"></a>API Details</h3><h5 id="Authorization"><a href="#Authorization" class="headerlink" title="Authorization"></a>Authorization</h5><p>跟其他如contacts、core location的API类似，<code>CallKit</code>也需要向用户请求准许的权限。正因为如此，每次app启动之后，你的app要做的第一件事就是检查当前的授权状态。因为可能在上次启动app之后用户进入到设置中修改了权限。如果你发现你的app的授权状态是不允许的，你应该为你的app请求授权。系统会弹框向用户请求允许权限。最后，当你的app启动时，你应该去观察并监听任何授权状态的改变，这样你才能一直将最新的UI展示给你的用户。</p>
<p><img src="/images/callkit/10.png" alt=""></p>
<h5 id="Provider-Configuration"><a href="#Provider-Configuration" class="headerlink" title="Provider Configuration"></a>Provider Configuration</h5><p><code>Provider Configuration</code>可以帮助你的app自定义通话界面。比如说，你的app在通话界面显示的名称，还有是否支持视频通话，指定显示在通话UI最后的button图片，点击这个button可以直接跳转到你的app中。</p>
<h5 id="Actions-Error"><a href="#Actions-Error" class="headerlink" title="Actions Error"></a>Actions Error</h5><p>我们已经知道了在不发生错误的情况下action发生的过程。那么要是在执行过程中发生错误了呢？比如，网络连接发生异常，我们无法建立起通话连接。在这种情况下，action会执行失败。</p>
<p><img src="/images/callkit/15.png" alt=""></p>
<p>其中的过程是这样的：action通知系统发生错误，系统转而通过像通话失败UI来告诉用户通话请求失败。与这些action错误连同一起的是<code>action timeouts</code>。系统的每个action都有其特定的过期时间，这些时间很重要，它们确保了被用户启动的action执行的顺畅。如果action执行超时，provider的代理方法会通知app来正确响应此时的操作。</p>
<h5 id="System-Restrictions"><a href="#System-Restrictions" class="headerlink" title="System Restrictions"></a>System Restrictions</h5><p>现实中你可能会遇到来电被拒。来电被拒绝的原因可能是用户禁用了你的app并且不再给予授权，可能是你的来电被用户列入黑名单中，可能是用户开启勿扰模式。在这些情况下，API中的competition handler会通知你的app。例如<code>reportNewIncomingCall</code>API会在它的completion handler传入一个error。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">provider.reportNewIncomingCall(with: <span class="type">UUID</span>(), update: <span class="type">CXCallUpdate</span>()) &#123; error <span class="keyword">in</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">let</span> incomingCallError = error,</div><div class="line">    incomingCallErrorCode = <span class="type">CXErrorCodeIncomingCallError</span>(rawValue: incomingCallError.code) <span class="keyword">where</span> incomingCallErrorCode == .filteredByDoNotDisturb &#123;</div><div class="line"> <span class="comment">// handle do not disturb</span></div><div class="line"> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="Audio"><a href="#Audio" class="headerlink" title="Audio"></a>Audio</h5><p>由于有<code>CallKit</code>，你的app的通话音频得到了很多好处。其中最大的好处就是你的音频会话的优先级比系统通话和Facetime更高，这意味着系统其它的app不能够打断你的app的音频通话。</p>
<p>现在以来电流程举例。我们知道当有来电时，app会收到应答action然后执行action。在接收action后是配置音频会话最佳的时间点，这是因为我们知道这时候通话即将变成connected状态。当我们执行应答action后，系统会优先自动为app开启音频会话，然后通过音频会话提供者的代理方法的回调来告诉app发生了什么。</p>
<p><img src="/images/callkit/16.png" alt=""></p>

    

    
</div>


                

                <!-- Post Comments -->
                
                    




                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2016/08/24/拆解ARC下的self/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2016/07/26/iOS 10推送通知小记（下）/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="zakariyyasv's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        zakariyyasv@gmail.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/" target="_self">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2016/10/">十月 2016<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/09/">九月 2016<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/08/">八月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/07/">七月 2016<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/05/">五月 2016<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/04/">四月 2016<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/03/">三月 2016<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/02/">二月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/01/">一月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/12/">十二月 2015<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/10/">十月 2015<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/09/">九月 2015<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/twitter" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-twitter.png);">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/facebook" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-facebook.png);">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-gplus.png);">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/ZakariyyaSv" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.png);">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;
            <script type="text/javascript">
                var fd = new Date();
                document.write(fd.getFullYear());
            </script>
            &nbsp;zakariyyasv's blog
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->
<script src="/js/lazyload.min.js"></script>
<script src="/js/js.min.js"></script>
<script src="/js/nprogress.js"></script>

<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>













<!-- Swiftye -->


<!-- Local Search-->


<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->


                </main>
            </div>
        </body>
    
</html>
