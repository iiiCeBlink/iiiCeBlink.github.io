<!DOCTYPE html>
<html lang="zh">
    <head>
    <!-- 
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.3.0 -->

    <!-- Title -->
    
    <title>
        
            iOS 10推送通知小记（下） | 
        
        zakariyyasv&#39;s blog
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!-- Meta & Info -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="zakariyyasv">
    <meta name="description" content="Just forcus">
    <meta name="keywords" content="null">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="zakariyyasv&#39;s blog">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://zakariyyasv.pub">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="iOS 10推送通知小记（下） | zakariyyasv&#39;s blog">
    <meta property="og:description" content="Just forcus">
    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.en.js"></script>
        
    <![endif]-->

    <!-- Import CSS -->
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="/css/style.min.css">
    <!-- Config CSS -->


<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }
</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>



    <script src="/js/jquery.min.js"></script>
    <script src="/js/queue.js"></script>

    <!-- UC Browser Compatible -->
    <script>
        var agent = navigator.userAgent.toLowerCase();
        if(agent.indexOf('ucbrowser')>0) {
            document.write("<link rel=\"stylesheet\" href=\"/css/uc.css\">");
            alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
        }
    </script>

    

    

    <!-- Bing Background -->
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Overview"><span class="post-toc-number">1.</span> <span class="post-toc-text">Overview</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Registration"><span class="post-toc-number">2.</span> <span class="post-toc-text">Registration</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Content"><span class="post-toc-number">3.</span> <span class="post-toc-text">Content</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Scheduling"><span class="post-toc-number">4.</span> <span class="post-toc-text">Scheduling</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Management"><span class="post-toc-number">5.</span> <span class="post-toc-text">Management</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Actions"><span class="post-toc-number">6.</span> <span class="post-toc-text">Actions</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Service-extension"><span class="post-toc-number">7.</span> <span class="post-toc-text">Service extension</span></a></li></ol>

        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script>
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').css('background-image', 'url(' + '/img/random/material-' + randomNum + '.png' + ')');
</script>

        
    
            <p class="article-headline-p">
                iOS 10推送通知小记（下）
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>zakariyyasv</strong>
        <span>7月 26, 2016</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=iOS 10推送通知小记（下）&url=http://zakariyyasv.pub//2016/07/26/iOS 10推送通知小记（下）/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=iOS 10推送通知小记（下）&url=http://zakariyyasv.pub//2016/07/26/iOS 10推送通知小记（下）/index.html&via=zakariyyasv" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://zakariyyasv.pub//2016/07/26/iOS 10推送通知小记（下）/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://zakariyyasv.pub//2016/07/26/iOS 10推送通知小记（下）/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p>在上一篇<a href="http://zakariyyasv.pub/2016/07/23/iOS%2010%E6%8E%A8%E9%80%81%E9%80%9A%E7%9F%A5%E5%B0%8F%E8%AE%B0%EF%BC%88%E4%B8%8A%EF%BC%89/">iOS 10推送通知小记（上）</a>中，已经将iOS 10推送机制的改进以及原理讲完了。本篇文章的着重点放在心的推送框架<code>UserNotification.framework</code>上面。</p>
<p>先说说iOS 10之前的推送API中存在的问题。比如，本地推送和远程推送使用的是不同的回调方法但有可能回调方法中的代码是重复的。当你的app将通知发送给用户之后就没办法再去控制它了。为了解决这些问题，iOS 10推出了新的推送框架——<code>UserNotification.framework</code>。<br><a id="more"></a><br>新框架的主要特性有：</p>
<blockquote>
<ul>
<li>与之前的API相似，改写原来的代码很简单。</li>
<li>扩展通知的内容。</li>
<li>本地推送和远程推送执行相同的回调方法。</li>
<li>简化代理方法。</li>
<li>更好的推送管理。app可以访问将被发送或者已经发送给用户的通知并且允许在更新通知的时候移除它。</li>
<li>通知内容可以展示app内的界面内容。</li>
</ul>
</blockquote>
<h3 id="Registration"><a href="#Registration" class="headerlink" title="Registration"></a>Registration</h3><p>如今，通知消息对用户来说是种干扰或者打断。因此，在你给用户发送通知消息之前得到用户的授权和允许是非常重要的。你可以向用户请求横幅、声音或者app角标的权限，这样用户可以第一时间看到你的推送通知。本地推送与远程推送都需要做注册操作。</p>
<p>注册代码编写很简单，只需要调用UN的userNotification对象的request方法，并传入正确的参数即可。注意，现在用户对于每个应用允许的权限可以在应用的设置菜单中单独设置，用户可以依据个人的偏好去开启或关闭通知。在iOS 10中，开发者可以获取用户设置的权限，因而可以依据用户的偏好设置而发送对应的通知消息。</p>
<p>本地推送的注册到此就结束了，但是远程推送还没有结束。注册远程推送需要连接网络跟APNS进行通信获取设备的device token，你需要将这个token发送给应用的服务端。这个token非常重要，远程推送通知的负载需要包含这个token。device token相当于验证你的设备和应用程序之间的钥匙。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// RequestAuthorization</span></div><div class="line"><span class="type">UNUserNotificationCenter</span>.current().requestAuthorization([.alert, .sound, .badge])</div><div class="line"> &#123; (granted, error) <span class="keyword">in</span> <span class="comment">// ... &#125;</span></div><div class="line"> </div><div class="line"> <span class="comment">// Access to user-defined settings</span></div><div class="line"> <span class="type">UNUserNotificationCenter</span>.current().getNotificationSettings &#123; (settings) <span class="keyword">in</span> <span class="comment">// ... &#125;</span></div><div class="line"> </div><div class="line"> <span class="comment">// Register remote notifications</span></div><div class="line"> <span class="type">UIApplication</span>.shared().registerForRemoteNotifications()</div></pre></td></tr></table></figure>
<h3 id="Content"><a href="#Content" class="headerlink" title="Content"></a>Content</h3><p>在iOS 10中，推送通知加入了subtitle，可以给用户展示更多的信息。</p>
<p><img src="/images/notificationAPI/1.png" alt=""></p>
<p>创建通知内容很简单，只需要创建<code>UNMutableNotificationContent</code>对象并且设置里面不同的属性就可以了。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// local notification</span></div><div class="line"><span class="keyword">let</span> content = <span class="type">UNMutableNotificationContent</span>()</div><div class="line">content.title = <span class="string">"Introduction to Notifications"</span></div><div class="line">content.subtitle = <span class="string">"Session 707"</span></div><div class="line">content.body = <span class="string">"Woah! These new notifications look amazing! Don’t you agree?"</span></div><div class="line">content.badge = <span class="number">1</span></div></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// remote notification payload</span></div><div class="line">&#123;</div><div class="line"> <span class="string">"aps"</span> : &#123;</div><div class="line"> <span class="string">"alert"</span> : &#123;</div><div class="line"> <span class="string">"title"</span> : <span class="string">"Introduction to Notifications"</span>,</div><div class="line"> <span class="string">"subtitle"</span> : <span class="string">"Session 707"</span></div><div class="line">,</div><div class="line"> <span class="string">"body"</span> : <span class="string">"Woah! These new notifications look amazing! Don’t you agree?"</span></div><div class="line"> &#125;,</div><div class="line"> <span class="string">"badge"</span> : <span class="number">1</span></div><div class="line"> &#125;,</div><div class="line"> my-attachment : https:<span class="comment">//example.com/phtos.jpg"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Scheduling"><a href="#Scheduling" class="headerlink" title="Scheduling"></a>Scheduling</h3><p>iOS 10发送通知的过程可以总结如下：</p>
<blockquote>
<ul>
<li>注册通知申请权限。</li>
<li>设置通知的内容</li>
<li>设置触发器</li>
<li>设置通知标识符</li>
<li>发送通知</li>
</ul>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Notification Delivery Summary</span></div><div class="line"><span class="keyword">import</span> UserNotifications</div><div class="line"><span class="type">UNUserNotificationCenter</span>.current().requestAuthorization([.alert, .sound, .badge])</div><div class="line"> &#123; (granted, error) <span class="keyword">in</span> <span class="comment">// ... &#125;</span></div><div class="line"><span class="keyword">let</span> content = <span class="type">UNMutableNotificationContent</span>()</div><div class="line">content.title = <span class="string">"Introduction to Notifications"</span></div><div class="line">content.body = <span class="string">"Let's talk about notifications!"</span></div><div class="line"></div><div class="line"><span class="keyword">let</span> trigger = <span class="type">UNTimeIntervalNotificationTrigger</span>(timeInterval: <span class="number">5</span>, repeats: <span class="literal">false</span>)</div><div class="line"></div><div class="line"><span class="keyword">let</span> requestIdentifier = <span class="string">"sampleRequest"</span></div><div class="line"><span class="keyword">let</span> request = <span class="type">UNNotificationRequest</span>(identifier: requestIdentifier,</div><div class="line"> content: content,</div><div class="line"> trigger: trigger)</div><div class="line"></div><div class="line"><span class="type">UNUserNotificationCenter</span>.current().add(request) &#123; (error) <span class="keyword">in</span> <span class="comment">// ... &#125;</span></div></pre></td></tr></table></figure>
<p>以上说的是应用程序在后台的时候推送通知的产生过程。那要是应用程序在前台运行呢？这时候我们需要实现<code>UNUserNotificationCenter</code>的代理方法才能支持在前台中处理推送通知。代理方法中有个叫做<code>willPresent notification:</code>，该方法能让你获取推送通知中的内容。如果你想设置弹窗、声音或者in-app显示，可以通过调用<code>handlerBlock</code>方法设置不同的参数达到效果。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">UNUserNotificationCenterDelegate</span> : <span class="title">NSObjectProtocol</span></span></div><div class="line"><span class="title">func</span> <span class="title">userNotificationCenter</span>(<span class="title">_</span> <span class="title">center</span>: <span class="title">UNUserNotificationCenter</span>, <span class="title">willPresent</span> <span class="title">notification</span>: <span class="title">UNNotification</span>, <span class="title">withCompletionHandler</span> <span class="title">completionHandler</span>: (<span class="title">UNNotificationPresentationOptions</span>) -&gt; <span class="title">Void</span>)&#123;</div><div class="line">    <span class="comment">// Roll banner and sound alert</span></div><div class="line">     handlerBlock([.alert, .sound]) </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Management"><a href="#Management" class="headerlink" title="Management"></a>Management</h3><p>在iOS 10新的推送框架中，推送通知的管理可以做的事情很多：</p>
<blockquote>
<p>访问推送消息</p>
<ul>
<li>将要发送的通知</li>
<li>已经发送的通知<br>移除推送消息<br>更新修改推送消息 </li>
</ul>
</blockquote>
<p>在推送通知管理中非常重要的一部分是<code>request identifier</code>。在本地推送中，请求标识符被设置在消息请求当中，在远程推送中，请求标识符被设置在新的HTTP/2请求头中——<code>apns-collapse-id</code>。系统通过这个标识符知道哪个通知是需要移除或者更新的。</p>
<p>在下面例子中，你的app想发送关于游戏的通知，它想通知游戏开始的时间。因此你创建推送请求并且将其放入系统的schedule中。但是，现在需要告知游戏被取消了。这时候就需要调用<code>removePendingNotificationRequests</code>方法并传入创建推送请求时传入的标识符。那如何更新游戏的开始时间呢？你需要创建新的请求，并传入与之前相同的标识符，设置新的时间并放入系统的schedule中。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Pending Notification Removal</span></div><div class="line"><span class="keyword">let</span> gameStartIdentifier = <span class="string">"game1.start.identifier"</span></div><div class="line"><span class="keyword">let</span> gameStartRequest = <span class="type">UNNotificationRequest</span>(identifier: gameStartIdentifier, content: content, trigger: startTrigger)</div><div class="line"><span class="type">UNUserNotificationCenter</span>.current().add(gameStartRequest) &#123; (error) <span class="keyword">in</span> <span class="comment">// ... &#125;</span></div><div class="line"><span class="comment">// Game was cancelled</span></div><div class="line"><span class="type">UNUserNotificationCenter</span>.current().removePendingNotificationRequests(withIdentifiers: [gameStartIdentifier])</div><div class="line"><span class="comment">// Game start time was updated</span></div><div class="line"><span class="keyword">let</span> updatedGameStartRequest = <span class="type">UNNotificationRequest</span>(identifier: gameStartIdentifier,</div><div class="line"> content: content,</div><div class="line"> trigger: newStartTrigger)</div><div class="line"><span class="type">UNUserNotificationCenter</span>.current().add(updatedGameStartRequest) &#123; (error) <span class="keyword">in</span> <span class="comment">// ... &#125;</span></div></pre></td></tr></table></figure>
<p>下面再来说说通知已经发送出去的情况。我们举足球比分的例子来说明。你创建了通知请求并将其发送到系统。但是通知更新的是错误的比分，这时候你可以很简单地通过调用<code>removeDeliveredNotifications</code>来移除之前的通知。当然，你也可以创建新的推送请求更新原来通知的比分。当然，这两种做法都要传入相同的请求标识符。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Delivered Notification Removal</span></div><div class="line"><span class="keyword">let</span> gameScoreIdentifier = <span class="string">"game1.score.identifier"</span></div><div class="line"><span class="keyword">let</span> gameScoreRequest = <span class="type">UNNotificationRequest</span>(identifier: gameScoreIdentifier,</div><div class="line"> content: scoreContent,</div><div class="line"> trigger: trigger)</div><div class="line"><span class="type">UNUserNotificationCenter</span>.current().add(gameScoreRequest) &#123; (error) <span class="keyword">in</span> <span class="comment">// ... &#125;</span></div><div class="line"><span class="comment">// Wrong game score was published</span></div><div class="line"><span class="type">UNUserNotificationCenter</span>.current().removeDeliveredNotifications(withIdentifiers: [gameScoreIdentifier])</div><div class="line"><span class="comment">// Score game was updated</span></div><div class="line"><span class="keyword">let</span> updateGameScoreRequest = <span class="type">UNNotificationRequest</span>(identifier: gameScoreIdentifier,</div><div class="line"> content: newScoreContent,</div><div class="line"> trigger: newTrigger)</div><div class="line"><span class="type">UNUserNotificationCenter</span>.current().add(updateGameScoreRequest) &#123; (error) <span class="keyword">in</span> <span class="comment">// ... &#125;</span></div></pre></td></tr></table></figure>
<h3 id="Actions"><a href="#Actions" class="headerlink" title="Actions"></a>Actions</h3><p>下面介绍用户接收到推送通知后的处理操作。app可以识别用户对于通知消息处理的三种类型操作。</p>
<p>第一种类型操作是最常规的，那就是用户点击推送消息打开app。这个操作可以在设备解锁并且接收到推送消息，用户点击横幅时发生。也可以在锁屏状态下用户向右滑动消息，在下拉通知中心点击消息发生这个操作。</p>
<p><img src="/images/notificationAPI/2.png" alt=""></p>
<p>第二种类型操作是自定义快捷操作行为。这时候的推送消息就是可以执行操作的消息。这些自定义操作行为以按钮的形式出现在推送消息的下面。在iOS 9中引入了textinput action，这样用户可以快速回复消息。这些自定义的快捷操作行为可以在前台可以在后台中。</p>
<p>在后台中执行action会移除消息并且会给后台很短的一段时间去处理用户点击的action触发的事件。另一方面，在前台中执行action会移除消息并且启动app这样app就可以处理action触发的事件。</p>
<p><img src="/images/notificationAPI/3.png" alt=""></p>
<p>所有的自定义快捷操作都需要与category关联起来。category需要唯一的标识符，这个标识符会设置到所有你想要的action中。除此之外，你还可以设置intent标识符，关于intent的更多信息可以参考SiriKit Session。当你创建完所有的action和category时，你需要做的唯一的事情就是将它们注册到<code>UNUserNotificationCenter</code>对象中与你的应用程序相关联。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">let action = UNNotificationAction(identifier:”reply",title:"Reply",options:[])</div><div class="line">let category = UNNotificationCategory(identifier: "message", actions: [action], minimalActions: [action], intentIdentifiers: [], options: [])</div><div class="line">UNUserNotificationCenter.current().setNotificationCategories([category])</div></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Remote Notifications</span></div><div class="line">&#123;</div><div class="line">    aps : &#123;</div><div class="line">        alert : “<span class="type">Welcome</span> to <span class="type">WWDC</span> !”,</div><div class="line">        category: <span class="string">"message"</span></div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Local Notifications</span></div><div class="line">content.categoryIdentifier = <span class="string">"message"</span></div></pre></td></tr></table></figure>
<p>接下来说说如何将自定义的aciton展示给你的用户。在远程推送中，你需要在远程推送通知的APS字典中设置category标识符。现在这个标识符需要与之前注册的category标识符能匹配上。在本地推送中，你需要在创建的推送内容中设置category标识符。同样的，这个category标识符必须与注册的category标识符能匹配上。</p>
<p>第三种类型操作是dismiss行为。该行为在用户移除指定的通知消息时触发。比如说，你有个日历app，你给用户发送了一条关于即将到来的会议的远程推送通知。用户看到了这则通知并移除它时，你想要停止向该用户其他的设备再发送这条用户已经看到的远程推送通知。那用户如何才算是真正地移除通知消息呢？用户可以在锁屏界面或者下拉通知中心中从右向左滑动消息并点击“清除”按钮。</p>
<p>在之前讨论的注册不同的category时，我们提到一些选项，<code>customDismissAction</code>选项是其中的一个。我们需要做的是将<code>customDismissAction</code>添加到category中，那么当用户移除跟category关联的通知消息时，app将会接收到dismiss行为。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">customDismissAction: <span class="type">UNNotificationCategoryOptions</span></div><div class="line"><span class="keyword">let</span> category = <span class="type">UNNotificationCategory</span>(identifier: <span class="string">"message"</span>, actions: [action],</div><div class="line">minimalActions: [action], intentIdentifiers: [], options: [.customDismissAction])</div></pre></td></tr></table></figure>
<p>以上就是关于自定义通知行为的三种类型的介绍。那么自定义行为的操作的处理在哪里进行呢？在<code>UNUserNotificationCenter</code>代理方法中有这样一个方法——<code>didReceive response:</code>,实现这个方法来处理自定义行为的操作。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">UNUserNotificationCenterDelegate</span> : <span class="title">NSObjectProtocol</span></span></div><div class="line">    <span class="title">func</span> <span class="title">userNotificationCenter</span>(<span class="title">_</span> <span class="title">center</span>: <span class="title">UNUserNotificationCenter</span>, <span class="title">didReceive</span> <span class="title">response</span>: <span class="title">UNNotificationResponse</span>, <span class="title">withCompletionHandler</span> <span class="title">completionHandler</span>: () -&gt; <span class="title">Void</span>)</div></pre></td></tr></table></figure>
<p>我们把目光聚焦到该方法中的<code>UNNotificationResponse</code>上。这个对象中包含你创建的action的<code>action identifier</code>，如果这个action是<code>text input action</code>，那还会有<code>user text</code>属性。它还包含一个通知消息对象，消息对象中自然还包含请求对象以及标识符。</p>
<p><img src="/images/notificationAPI/4.png" alt=""></p>
<h3 id="Service-extension"><a href="#Service-extension" class="headerlink" title="Service extension"></a>Service extension</h3><p>再来谈谈远程推送。iOS 10引入了<code>service extension</code>，它的作用是在远程推送中在推送通知展示到用户之前添加或者修改通知消息中的内容，同时，还会对消息中的内容进行端对端的加密。注意，它是在后台运行工作的。关于<code>service extension</code>工作原理的介绍已经在前一篇文章中解释过了。现在重点讲述如何代码实现<code>service extension</code>。</p>
<p>首先，你需要做的是在Xcode项目中添加新的target，如下图所示。</p>
<p><img src="/images/notificationAPI/5.png" alt=""></p>
<p>之后在这个模板中会有一个类。它是<code>UNNotificationServiceExtension</code>类的子类。它有两个主要的方法。第一个方法可以获取当前的推送请求对象，可以在其中修改推送消息的内容。当<code>service extension</code>运行超时时，第二个方法会被触发。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Service Extension</span></div><div class="line"><span class="keyword">import</span> UserNotifications</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotificationService</span>: <span class="title">UNNotificationServiceExtension</span> </span>&#123;</div><div class="line">     <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">didReceive</span><span class="params">(request: UNNotificationRequest, withContentHandler contentHandler:<span class="params">(UNNotificationContent)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</div><div class="line">     <span class="comment">// Modify the notification content</span></div><div class="line"> &#125;</div><div class="line">     <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">serviceExtensionTimeWillExpire</span><span class="params">()</span></span> &#123;</div><div class="line">     <span class="comment">// Called before the extension will be terminated by the system</span></div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来我们来看看如何在远程推送中真正地触发上面这段代码。下面是远程推送消息的简易版本，其中有一个新的<code>mutable-content</code>字段。你需要用这个字段来让系统知道你想要系统启动<code>service extension</code>去更新远程推送消息中的内容。当然你不必每次都去启动<code>service extension</code>服务，只需要在需要更新推送通知内容的时候再去启动它。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Example payload</span></div><div class="line">&#123;</div><div class="line">    aps : &#123;</div><div class="line">        alert : “<span class="type">New</span> <span class="type">Message</span> <span class="type">Available</span>”,</div><div class="line">        mutable-content : <span class="number">1</span></div><div class="line">    &#125;,</div><div class="line">    encrypted-content : “#myencryptedcontent”</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们再来看看如何去解密远程推送通知中加密的内容。在下面代码中，我们看到了<code>didReceive</code>方法。该方法是推送请求的方法，在这个方法中要做的事情就是解密远程推送通知中加密的内容。然后，我们创建一个<code>UNMutableNotificationContent</code>对象并将解密出来的内容赋给它。最后，我们调用<code>contentHandler</code>方法将解密的内容展示在用户面前。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Decrypt Remote Notification Payload in Service Extension and Update Notification Content</span></div><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">didReceive</span><span class="params">(request: UNNotificationRequest, withContentHandler contentHandler:<span class="params">(UNNotificationContent)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</div><div class="line">     <span class="comment">// Decrypt the payload</span></div><div class="line">     <span class="keyword">let</span> decryptedBody = decrypt(request.content.userInfo[“encrypted-content”])</div><div class="line">     <span class="keyword">let</span> newContent = <span class="type">UNMutableNotificationContent</span>()</div><div class="line">     <span class="comment">// Modify the notification content</span></div><div class="line">     newContent.body = decryptedBody</div><div class="line">     <span class="comment">// Call content handler with updated content</span></div><div class="line">     contentHandler(newContent)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
    

    
</div>


                

                <!-- Post Comments -->
                
                    




                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2016/07/30/CallKit学习笔记/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2016/07/23/iOS 10推送通知小记（上）/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="zakariyyasv's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        zakariyyasv@gmail.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/" target="_self">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2016/10/">十月 2016<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/09/">九月 2016<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/08/">八月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/07/">七月 2016<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/05/">五月 2016<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/04/">四月 2016<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/03/">三月 2016<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/02/">二月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/01/">一月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/12/">十二月 2015<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/10/">十月 2015<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/09/">九月 2015<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/twitter" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-twitter.png);">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/facebook" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-facebook.png);">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-gplus.png);">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/ZakariyyaSv" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.png);">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;
            <script type="text/javascript">
                var fd = new Date();
                document.write(fd.getFullYear());
            </script>
            &nbsp;zakariyyasv's blog
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->
<script src="/js/lazyload.min.js"></script>
<script src="/js/js.min.js"></script>
<script src="/js/nprogress.js"></script>

<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>













<!-- Swiftye -->


<!-- Local Search-->


<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->


                </main>
            </div>
        </body>
    
</html>
